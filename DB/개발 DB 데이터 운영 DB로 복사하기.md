# 개발 DB 데이터 운영 DB로 복사하기

### TLTR
1. 개발 DB에서 복사하려는 테이블의 레코드를 모두 추출한다.(export)
2. 운영 DB에 테이블을 생성하고 개발 DB에서 추출한 레코드를 모두 입력한다.(import)
3. 필요한 레코드를 복사한다. (UPDATE)
4. 운영 DB에 생성한 테이블을 삭제한다. (DROP)

### 배경
좌석 배정 프로그램을 운영 중인데 UI에서 나타는 좌석의 위치를 DB에 관리하고 있다.
최근에 기존 좌석 배정 프로그램을 신규 버전으로 리뉴얼하는 과정에서 UI에 좌석을 나타내는 방식이 개선되었는데
신규 버전이 단계적으로 도입될 예정이기 때문에, 기존 좌석 배정 프로그램 또한 계속 운영되어야 한다는 이슈가 있었다.
즉, 운영 DB에서 관리 중인 기존 좌석 위치 값을 변경할 수 없다는 의미였다.
그리고 좌석을 이용하면 누가 언제 이용했는지 기록이 남는데, 신규 좌석 배정 프로그램으로 교체되어도 좌석 번호는 동일하기 때문에 각 좌석 이용 기록 또한 계속 유지해야 했다.
따라서 개발 과정에서 기존 좌석 위치 값을 건드릴 수 없었고, 새로운 컬럼 두 개를 추가해서 새로운 좌석 위치 값을 반영했다.
테이블 구조로 보면 다음과 같다.

##### 기존 프로그램의 운영 DB
xAxis와 yAxis가 기존에 사용 중인 좌석의 위치 값이다.

id(PK) | number | xAxis | yAxis | userId(FK)
-------|--------|-------|-------|-----------
1      |1       |1      |1      |7738
2      |2       |2      |2      |4312
3      |3       |3      |3      |9336
...    |...     |...    |...    |...

##### 신규 프로그램이 적용될 개발 DB
기존 좌석 이용 정보를 유지하면서 새로 추가된 좌석 위치 값을 반영하기 위해 xAxis_v2, yAxis_v2 컬럼이 추가되었다.

id(PK) | number | xAxis  | yAxis | xAxis_v2 | yAxis_v2 | userId(FK)
-------|--------|--------|-------|----------|----------|----------
1      |1       |1       |1      |0.231     |0.863     |7738
2      |2       |2       |2      |0.531     |0.774     |4312
3      |3       |3       |3      |0.871     |0.710     |9336
...    |...     |...     |...    |...       |...       |...    

그렇게 해서 신규 좌석 배정 기능 개발이 완료되었는데 개발 과정에서 개발 DB에 신규 좌석의 위치를 재배치하다 보니
운영 서버에 해당 기능들이 도입되었을 때, 다시 좌석을 재배치해야되는 문제점이 있었다.
그래서 신규 좌석 배치를 위해 입력된 개발 DB의 xAxis_v2와 yAxis_v2 컬럼 값을 운영 DB의 xAxis, yAxis 컬럼에 복사할 방법이 필요했다.


### 해결
DB의 export 기능을 사용하여 개발 DB에서 복사하려는 테이블의 레코드를 모두 추출했다.
레코드 추출에 모두 성공하면 레코드 데이터를 담고 있는 .csv 확장자명의 파일이 하나 생성되는데, 이 파일에 담긴 레코드들을
운영 DB에 기존 좌석 테이블과 동일한 구조의 테이블을 하나 생성한 뒤 DB의 import 기능을 사용하여 모두 입력했다.
그리고 다음 SQL처럼 UPDATE를 사용하여 필요한 레코드를 복사해왔다.

```sql
UPDATE "seat" AS "s1"
SET "s1"."xAxis" = "s2"."xAxis_v2", "s1"."yAxis" = "s2"."yAxis_v2"
FROM "seat2" AS "s2"
WHERE "s1"."id" = "s2"."id";
```

마지막으로 필요한 레코드를 복사했기 때문에 더이상 새로 추가된 두 개의 컬럼과 테이블이 필요없어졌다.
그래서 다음 SQL을 실행하여 운영 DB에서 삭제했다.

```sql
# 컬럼 삭제
ALTER TABLE "seat"
DROP COLUMN "xAxis_v2",
DROP COLUMN "yAxis_v2";
# 테이블 삭제
DROP TABLE "seat2";
```
